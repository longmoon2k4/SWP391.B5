<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.name}"></title>
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css"/>
    <style>
        /* Safeguard: prevent long values from breaking sidebar layout */
        .product-page .info-list .value {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        @media (max-width: 992px) {
            .product-page .info-list li { flex-wrap: wrap; }
            .product-page .info-list .value { white-space: normal; }
        }
        .error-message { color: red; margin-top: 10px; }
    </style>
</head>
<body class="product-page">

<div th:replace="~{layout :: header}"></div>

<div class="main-content" th:if="${product}">
    <div class="product-detail-container">
        <!-- Main Content (Video, Description, Versions, Reviews) -->
        <div class="product-main-content">
            <h1 th:text="${product.name}">Tên sản phẩm</h1>

            <div class="product-video" th:if="${product.demoVideoUrl}">
                <iframe
                        th:attr="data-video-url=${product.demoVideoUrl}"
                        title="Product Demo"
                        loading="lazy"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen
                ></iframe>
            </div>

            <div class="product-description">
                <h2 class="section-title">Mô tả chi tiết</h2>
                <div th:utext="${product.description}"></div>
            </div>

            <!-- Version History -->
            <div class="version-history" th:if="${!product.versions.isEmpty()}">
                <h2 class="section-title">Lịch sử phiên bản</h2>
                <table class="version-history-table">
                    <thead>
                    <tr>
                        <th>Phiên bản</th>
                        <th>Ngày phát hành</th>
                        <th>Trạng thái</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="version : ${product.versions}">
                        <td th:text="${version.versionNumber}">1.0.0</td>
                        <td th:text="${#temporals.format(version.createdAt, 'dd-MM-yyyy')}">dd-MM-yyyy</td>
                        <td>
                            <span th:if="${version.isCurrentVersion}" class="current-version-badge">Hiện tại</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="product-reviews">
                <h2 class="section-title">Đánh giá từ người dùng <span th:text="'(' + ${#lists.size(product.reviews)} + ')'"></span></h2>
                <div th:if="${product.reviews.isEmpty()}">
                    <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                </div>
                <div class="review" th:each="review : ${product.reviews}">
                    <div class="review-avatar" th:text="${#strings.substring(review.user.fullName,0,1)}">U</div>
                    <div class="review-content">
                        <div class="review-header">
                            <p class="review-author" th:text="${review.user.fullName}">Tên người dùng</p>
                            <div class="review-meta" th:text="${#temporals.format(review.createdAt, 'dd-MM-yyyy')}">dd-MM-yyyy</div>
                        </div>
                        <p class="review-rating">
                            <span class="rating-badge" th:text="${review.rating} + '/5'">4/5</span>
                            <span class="stars" role="img" th:attr="aria-label=${review.rating} + ' trên 5 sao'">
                                <span th:each="i : ${#numbers.sequence(1,5)}"
                                      th:classappend="${i <= review.rating} ? ' star filled' : ' star'">★</span>
                            </span>
                            <span class="sr-only" th:text="'Đánh giá: ' + ${review.rating} + ' trên 5'"></span>
                        </p>
                        <div class="review-body" th:text="${review.comment}">Nội dung đánh giá.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar (Purchase & Info) -->
        <div class="product-sidebar">
            <div class="purchase-box">
                <h3>Mua sản phẩm</h3>
                <div th:if="${!product.packages.isEmpty()}">
                    <select id="packageSelect" class="package-select-dropdown" onchange="updateSidebarPrice()">
                        <option th:each="pkg : ${product.packages}"
                                th:value="${pkg.packageId}"
                                th:attr="data-price=${pkg.price}"
                                th:text="${pkg.name}">
                        </option>
                    </select>
                    <div id="sidebarPriceDisplay" class="price-display">
                        <span></span>
                    </div>
                    <button id="buy-now-btn" class="btn-buy">Thanh toán</button>
                    <div id="error-message" class="error-message"></div>
                </div>
                <div th:if="${product.packages.isEmpty()}">
                    <p>Sản phẩm này hiện chưa có gói giá nào.</p>
                </div>
            </div>

            <div class="info-box">
                <h3>Thông tin sản phẩm</h3>
                <ul class="info-list">
                    <li>
                        <span class="label">Dev: </span>
                        <span class="value" th:text="${product.developer.fullName}">Dev Name</span>
                    </li>
                    <li>
                        <span class="label">Danh mục:</span>
                        <span class="value" th:text="${product.category.name}">Category Name</span>
                    </li>
                    <li>
                        <span class="label">Lượt bán:</span>
                        <span class="value" th:text="${product.totalSales}">0</span>
                    </li>
                    <li>
                        <span class="label">Lượt xem:</span>
                        <span class="value" th:text="${product.viewCount}">0</span>
                    </li>
                    <th:block th:each="v : ${product.versions}" th:if="${v.isCurrentVersion}">
                        <li>
                            <span class="label">Phiên bản:</span>
                            <span class="value" th:text="${v.versionNumber}">1.0.0</span>
                        </li>
                    </th:block>
                    <li>
                        <span class="label">Ngày phát hành:</span>
                        <span class="value" th:text="${#temporals.format(product.createdAt, 'dd-MM-yyyy')}">dd-MM-yyyy</span>
                    </li>
                    <li>
                        <span class="label">Cập nhật lần cuối:</span>
                        <span class="value" th:text="${#temporals.format(product.updatedAt, 'dd-MM-yyyy')}">dd-MM-yyyy HH:mm</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div th:if="${product == null}" class="main-content">
    <p style="text-align: center;">Không tìm thấy sản phẩm.</p>
</div>

<div th:replace="~{layout :: footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = /*[[${_csrf.token}]]*/ null;
    const csrfHeader = /*[[${_csrf.headerName}]]*/ null;
    /*]]>*/

    function formatVND(value) {
        const num = Number(value || 0);
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            maximumFractionDigits: 0,
            minimumFractionDigits: 0
        }).format(num);
    }

    function updateSidebarPrice() {
        const selectElement = document.getElementById('packageSelect');
        const priceDisplaySpan = document.querySelector('#sidebarPriceDisplay span');
        if (selectElement && priceDisplaySpan) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            priceDisplaySpan.textContent = formatVND(price);
        }
    }

    function buildEmbedUrl(rawUrl) {
        if (!rawUrl) return null;
        try {
            const u = new URL(rawUrl);
            const host = u.hostname.replace('www.', '').toLowerCase();
            if (host.includes('youtube.com')) {
                const v = u.searchParams.get('v');
                if (v) return `https://www.youtube.com/embed/${v}`;
                const parts = u.pathname.split('/').filter(Boolean);
                const idx = parts.findIndex(p => ['shorts','live','embed'].includes(p));
                if (idx >= 0 && parts[idx+1]) return `https://www.youtube.com/embed/${parts[idx+1]}`;
            }
            if (host.includes('youtu.be')) {
                const id = u.pathname.split('/').filter(Boolean)[0];
                if (id) return `https://www.youtube.com/embed/${id}`;
            }
            if (host.includes('vimeo.com')) {
                const id = u.pathname.split('/').filter(Boolean).pop();
                if (id && /^\d+$/.test(id)) return `https://player.vimeo.com/video/${id}`;
            }
            return rawUrl;
        } catch (e) {
            return rawUrl;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const selectElement = document.getElementById('packageSelect');
        if (selectElement && selectElement.options.length > 0) {
            let minIndex = 0;
            let minValue = Number(selectElement.options[0].getAttribute('data-price'));
            for (let i = 1; i < selectElement.options.length; i++) {
                const val = Number(selectElement.options[i].getAttribute('data-price'));
                if (!isNaN(val) && val < minValue) {
                    minValue = val;
                    minIndex = i;
                }
            }
            selectElement.selectedIndex = minIndex;
            updateSidebarPrice();
        }

        const iframe = document.querySelector('.product-video iframe');
        if (iframe) {
            const raw = iframe.getAttribute('data-video-url');
            const embed = buildEmbedUrl(raw);
            if (embed) {
                iframe.src = embed;
            } else if (raw) {
                const overlay = document.createElement('a');
                overlay.href = raw;
                overlay.target = '_blank';
                overlay.rel = 'noopener noreferrer';
                overlay.style.position = 'absolute';
                overlay.style.inset = '0';
                overlay.style.display = 'block';
                overlay.style.background = 'transparent';
                iframe.parentElement.appendChild(overlay);
            }
        }

        const buyNowBtn = document.getElementById('buy-now-btn');
        const errorMessageDiv = document.getElementById('error-message');

        if (buyNowBtn) {
            buyNowBtn.addEventListener('click', async function() {
                const packageId = document.getElementById('packageSelect').value;
                if (!packageId) {
                    errorMessageDiv.textContent = 'Vui lòng chọn một gói.';
                    return;
                }

                // Disable button to prevent multiple clicks
                buyNowBtn.disabled = true;
                errorMessageDiv.textContent = '';

                try {
                    const headers = {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    };
                    if (csrfToken) {
                        headers[csrfHeader] = csrfToken;
                    }

                    const response = await fetch('/orders/checkout?packageId=' + packageId, {
                        method: 'POST',
                        headers: headers
                    });

                    if (response.status === 401) {
                        // Unauthorized, redirect to login
                        window.location.href = '/login';
                        return;
                    }

                    if (response.ok) {
                        const data = await response.json();
                        if (data.paymentUrl) {
                            window.location.href = data.paymentUrl;
                        } else {
                            errorMessageDiv.textContent = 'Không nhận được URL thanh toán.';
                        }
                    } else {
                        const errorData = await response.text();
                        errorMessageDiv.textContent = 'Lỗi: ' + (errorData || response.statusText);
                    }
                } catch (error) {
                    errorMessageDiv.textContent = 'Đã xảy ra lỗi kết nối. Vui lòng thử lại.';
                    console.error('Checkout error:', error);
                } finally {
                    // Re-enable the button
                    buyNowBtn.disabled = false;
                }
            });
        }
    });
</script>

</body>
</html>

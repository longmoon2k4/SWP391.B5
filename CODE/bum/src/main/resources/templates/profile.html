<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Hồ Sơ Người Dùng</title>
    <!-- Chỉ giữ lại link CSS chung cho header/footer -->
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css"/>
</head>
<body class="profile-page">

<div th:replace="~{layout :: header}"></div>

<main class="main-content" role="main" aria-labelledby="profile-title">
    <h1 id="profile-title">Hồ Sơ Của Bạn</h1>

    <!-- Vùng hiển thị thông báo -->
    <section aria-live="polite" th:if="${successMessage != null or errorMessage != null}">
        <p class="message-success" th:if="${successMessage}" th:text="${successMessage}"></p>
        <p class="message-error" th:if="${errorMessage}" th:text="${errorMessage}"></p>
    </section>

    <!-- Phần hiển thị thông tin -->
    <div id="profile-card">
        <form id="profile-form" th:action="@{/profile/update}" th:object="${updateProfileRequest}" method="post">
            <div>
                <strong>Họ và tên:</strong>
                <span class="view-mode" th:text="${loggedInUser.fullName}"></span>
                <div class="edit-mode" style="display: none;">
                    <input type="text" th:field="*{fullName}">
                    <div class="field-error" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>
                </div>
            </div>
            <div>
                <strong>Email:</strong>
                <span class="view-mode" th:text="${loggedInUser.email}"></span>
                <div class="edit-mode" style="display: none;">
                    <input type="email" th:field="*{email}">
                    <div class="field-error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                </div>
            </div>
            <div><strong>Tên đăng nhập:</strong> <span th:text="${loggedInUser.username}"></span></div>
            <div><strong>Vai trò:</strong> <span th:text="${#strings.capitalize(loggedInUser.role.name())}"></span></div>
            <div><strong>Ngày tham gia:</strong> <span th:text="${#temporals.format(loggedInUser.createdAt, 'dd-MM-yyyy HH:mm')}"></span></div>
        </form>

        <div id="profile-view-actions">
            <button class="secondary" onclick="toggleEditMode(true)">Chỉnh sửa thông tin</button>
        </div>
        <div id="profile-edit-actions" style="display: none;">
            <button class="primary" type="submit" form="profile-form">Lưu thay đổi</button>
            <button class="secondary" type="button" onclick="toggleEditMode(false)">Hủy</button>
        </div>
    </div>

    <hr>

    <!-- Phần ví tiền -->
    <section class="wallet" aria-label="Ví người dùng">
        <h2>Ví của bạn</h2>
        <p><strong>Số dư:</strong> <span class="balance" th:text="${(loggedInUser.walletBalance != null ? #numbers.formatDecimal(loggedInUser.walletBalance, 1, 'COMMA', 0, 'POINT') : '0,00') + ' ₫'}"></span></p>
        <div class="wallet-actions">
            <button class="primary" onclick="openDepositModal()">Nạp tiền</button>
        </div>
    </section>
</main>

<!-- Modal Nạp tiền (giao diện cơ bản) -->
<div id="deposit-modal" aria-hidden="true" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="deposit-title">
        <span class="modal-close" onclick="closeDepositModal()" aria-label="Đóng">&times;</span>
        <h2 id="deposit-title">Nạp tiền vào ví</h2>
        <form th:action="@{/profile/deposit}" th:object="${depositRequest}" method="post">
            <div>
                <label for="amount">Số tiền muốn nạp:</label>
                <input type="number" id="amount" th:field="*{amount}" min="10000" step="1000" required>
                <div class="field-error" th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}"></div>
            </div>
            <button class="primary" type="submit">Xác nhận</button>
        </form>
    </div>
</div>

<div th:replace="~{layout :: footer}"></div>

<script th:inline="javascript">
    const modal = document.getElementById('deposit-modal');

    function toggleEditMode(isEditing) {
        const card = document.getElementById('profile-card');
        const viewModes = card.querySelectorAll('.view-mode');
        const editModes = card.querySelectorAll('.edit-mode');

        document.getElementById('profile-view-actions').style.display = isEditing ? 'none' : 'block';
        document.getElementById('profile-edit-actions').style.display = isEditing ? 'block' : 'none';

        viewModes.forEach(el => el.style.display = isEditing ? 'none' : 'block');
        editModes.forEach(el => el.style.display = isEditing ? 'block' : 'none');
    }

    function openDepositModal() {
        modal.style.display = 'block';
    }

    function closeDepositModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeDepositModal();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const errorTab = /*[[${errorTab}]]*/ null;
        if (errorTab === 'profile') {
            toggleEditMode(true);
        } else if (errorTab === 'deposit') {
            openDepositModal();
        }
    });
</script>

</body>
</html>

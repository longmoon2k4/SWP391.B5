<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>License Marketplace System</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css"/>
    <style>
        .product-card-link { text-decoration: none; color: inherit; display: block; }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body class="home-page">

<div th:replace="~{layout :: header}"></div>

<div class="main-content">
    <h2>Tất cả sản phẩm</h2>

    <form th:action="@{/}" method="get" class="filter-form">
        <div class="form-row">
            <div class="form-group">
                <label for="search">Tìm kiếm</label>
                <input type="text" id="search" name="search" th:value="${search}" placeholder="Nhập tên sản phẩm...">
            </div>
            <div class="form-group">
                <label for="category">Lọc theo danh mục</label>
                <select id="category" name="category">
                    <option value="">Tất cả danh mục</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat.categoryId}"
                            th:text="${cat.name}"
                            th:selected="${selectedCategoryId != null && selectedCategoryId == cat.categoryId}"></option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn">Áp dụng</button>
    </form>

    <div class="product-grid" th:if="${productPage != null && !productPage.isEmpty()}">
        <div th:each="product : ${productPage.content}" class="product-card-container">
            <a th:href="@{/product/{id}(id=${product.id})}" class="product-card-link">
                <div class="product-card">
                    <div>
                        <h3 th:text="${product.name}">Tên sản phẩm</h3>
                        <div class="product-meta">
                            <span><i class="fas fa-eye"></i> <span th:text="${product.viewCount}">0</span> Lượt xem</span>
                            <span><i class="fas fa-star"></i> <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}">0.0</span>/5.0</span>
                        </div>
                        <p th:text="${product.shortDescription}">Mô tả ngắn.</p>
                    </div>
                    <div>
                        <div class="package-selector" th:if="${!product.packages.isEmpty()}" onclick="event.preventDefault(); event.stopPropagation();">
                            <select class="package-select-dropdown" onchange="updatePrice(this)">
                                <option th:each="pkg : ${product.packages}"
                                        th:value="${pkg.packageId}"
                                        th:attr="data-price=${pkg.price}"
                                        th:text="${pkg.name}">
                                </option>
                            </select>
                            <div class="price-display">
                                <span></span>
                            </div>
                        </div>

                        <div class="product-actions" onclick="event.preventDefault(); event.stopPropagation();">
                            <button class="btn btn-secondary view-demo-btn"
                                    th:attr="data-video-url=${product.demoVideoUrl}"
                                    th:disabled="${product.demoVideoUrl == null}">
                                Xem Demo
                            </button>
                            <button class="btn btn-primary buy-now-btn">Mua Ngay</button>
                        </div>
                        <div class="error-message" style="display: none;"></div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div th:if="${productPage == null || productPage.isEmpty()}">
        <p>Không có sản phẩm nào để hiển thị.</p>
    </div>

    <div class="pagination" th:if="${productPage != null && productPage.totalPages > 1}">
        <a th:href="@{/(page=${productPage.number - 1}, search=${search}, category=${selectedCategoryId})}"
           th:classappend="${productPage.first ? 'disabled' : ''}">&laquo; Trước</a>
        <span th:each="i : ${#numbers.sequence(0, productPage.totalPages - 1)}">
            <a th:href="@{/(page=${i}, search=${search}, category=${selectedCategoryId})}"
               th:text="${i + 1}"
               th:classappend="${i == productPage.number ? 'current' : ''}"></a>
        </span>
        <a th:href="@{/(page=${productPage.number + 1}, search=${search}, category=${selectedCategoryId})}"
           th:classappend="${productPage.last ? 'disabled' : ''}">Sau &raquo;</a>
    </div>
</div>

<div id="videoPopup" class="video-popup">
    <div class="video-popup-content">
        <button id="closePopupBtn" class="close-popup">&times;</button>
        <iframe id="videoFrame" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
</div>

<div th:replace="~{layout :: footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = /*[[${_csrf.token}]]*/ null;
    const csrfHeader = /*[[${_csrf.headerName}]]*/ null;
    /*]]>*/

    function updatePrice(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        const priceDisplaySpan = selectElement.parentElement.querySelector('.price-display span');
        if (priceDisplaySpan) {
            priceDisplaySpan.textContent = new Intl.NumberFormat('vi-VN', {
                style: 'currency', currency: 'VND', maximumFractionDigits: 0, minimumFractionDigits: 0
            }).format(Number(price || 0));
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize prices and selections
        document.querySelectorAll('.package-selector').forEach(container => {
            const select = container.querySelector('.package-select-dropdown');
            if (!select) return;

            const opts = Array.from(select.options);
            if (opts.length > 0) {
                let minOption = opts[0];
                let minVal = Number(minOption.getAttribute('data-price') || Infinity);
                for (const o of opts) {
                    const val = Number(o.getAttribute('data-price') || Infinity);
                    if (val < minVal) { minVal = val; minOption = o; }
                }
                select.value = minOption.value;
            }
            updatePrice(select);
        });

        // Video Popup Logic
        const videoPopup = document.getElementById('videoPopup');
        const videoFrame = document.getElementById('videoFrame');
        const closePopupBtn = document.getElementById('closePopupBtn');

        function buildEmbedUrl(rawUrl) { /* ... same as product.html ... */ return rawUrl; }
        document.querySelectorAll('.view-demo-btn').forEach(button => {
            button.addEventListener('click', function () {
                const videoUrl = this.getAttribute('data-video-url');
                if (!videoUrl) return;
                const embedUrl = buildEmbedUrl(videoUrl) || videoUrl;
                videoFrame.src = embedUrl;
                videoPopup.style.display = 'flex';
            });
        });
        function closePopup() {
            videoPopup.style.display = 'none';
            videoFrame.src = '';
        }
        closePopupBtn.addEventListener('click', closePopup);
        videoPopup.addEventListener('click', e => { if (e.target === videoPopup) closePopup(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });

        // Checkout Logic
        document.querySelectorAll('.buy-now-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const card = this.closest('.product-card-container');
                const selectElement = card.querySelector('.package-select-dropdown');
                const errorDiv = card.querySelector('.error-message');
                const packageId = selectElement.value;

                button.disabled = true;
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';

                try {
                    const headers = { 
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    };
                    if (csrfToken) {
                        headers[csrfHeader] = csrfToken;
                    }

                    const response = await fetch('/api/v1/orders/checkout?packageId=' + packageId, {
                        method: 'POST',
                        headers: headers
                    });

                    // Check for unauthorized status first
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    if (response.ok) {
                        const data = await response.json();
                        if (data.paymentUrl) {
                            window.location.href = data.paymentUrl;
                        } else {
                            throw new Error('Không nhận được URL thanh toán.');
                        }
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Lỗi không xác định.');
                    }
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                } finally {
                    button.disabled = false;
                }
            });
        });
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>License Marketplace System</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css"/>
    <style>
        /* Thêm style cho thẻ a để nó không có gạch chân và có màu mặc định */
        .product-card-link {
            text-decoration: none;
            color: inherit;
            display: block; /* Để thẻ a chiếm toàn bộ không gian của thẻ con */
        }
    </style>
</head>
<body class="home-page">

<div th:replace="~{layout :: header}"></div>

<div class="main-content">
    <h2>Tất cả sản phẩm</h2>

    <!-- Search and Filter Form -->
    <form th:action="@{/}" method="get" class="filter-form">
        <div class="form-row">
            <div class="form-group">
                <label for="search">Tìm kiếm</label>
                <input type="text" id="search" name="search" th:value="${search}" placeholder="Nhập tên sản phẩm...">
            </div>
            <div class="form-group">
                <label for="category">Lọc theo danh mục</label>
                <select id="category" name="category">
                    <option value="">Tất cả danh mục</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat.categoryId}"
                            th:text="${cat.name}"
                            th:selected="${selectedCategoryId != null && selectedCategoryId == cat.categoryId}"></option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn">Áp dụng</button>
    </form>

    <!-- Product Grid -->
    <div class="product-grid" th:if="${productPage != null && !productPage.isEmpty()}">
        <!-- Bọc mỗi thẻ sản phẩm bằng một thẻ a -->
        <div th:each="product : ${productPage.content}" class="product-card-container">
            <a th:href="@{/product/{id}(id=${product.id})}" class="product-card-link">
                <div class="product-card">
                    <div>
                        <h3 th:text="${product.name}">Tên sản phẩm</h3>
                        <div class="product-meta">
                            <span><i class="fas fa-eye"></i> <span th:text="${product.viewCount}">0</span> Lượt xem</span>
                            <span><i class="fas fa-star"></i> <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}">0.0</span>/5.0</span>
                        </div>
                        <p th:text="${product.shortDescription}">Mô tả ngắn.</p>
                    </div>
                    <div>
                        <!-- Package Selector -->
                        <div class="package-selector" th:if="${!product.packages.isEmpty()}" onclick="event.preventDefault(); event.stopPropagation();">
                            <select class="package-select-dropdown" onchange="updatePrice(this)">
                                <option th:each="pkg : ${product.packages}"
                                        th:value="${pkg.price}"
                                        th:text="${pkg.name}">
                                </option>
                            </select>
                            <div class="price-display">
                                <span th:text="${#numbers.formatCurrency(product.packages[0].price)}"></span>
                            </div>
                        </div>

                        <!-- Product Actions -->
                        <div class="product-actions" onclick="event.preventDefault(); event.stopPropagation();">
                            <button class="btn btn-secondary view-demo-btn"
                                    th:attr="data-video-url=${product.demoVideoUrl}"
                                    th:disabled="${product.demoVideoUrl == null}">
                                Xem Demo
                            </button>
                            <button class="btn btn-primary buy-now-btn" th:data-product-name="${product.name}">Mua Ngay</button>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div th:if="${productPage == null || productPage.isEmpty()}">
        <p>Không có sản phẩm nào để hiển thị.</p>
    </div>

    <!-- Pagination -->
    <div class="pagination" th:if="${productPage != null && productPage.totalPages > 1}">
        <a th:href="@{/(page=${productPage.number - 1}, search=${search}, category=${selectedCategoryId})}"
           th:classappend="${productPage.first ? 'disabled' : ''}">
            &laquo; Trước
        </a>
        <span th:each="i : ${#numbers.sequence(0, productPage.totalPages - 1)}">
            <a th:href="@{/(page=${i}, search=${search}, category=${selectedCategoryId})}"
               th:text="${i + 1}"
               th:classappend="${i == productPage.number ? 'current' : ''}"></a>
        </span>
        <a th:href="@{/(page=${productPage.number + 1}, search=${search}, category=${selectedCategoryId})}"
           th:classappend="${productPage.last ? 'disabled' : ''}">
            Sau &raquo;
        </a>
    </div>
</div>

<!-- Video Popup -->
<div id="videoPopup" class="video-popup">
    <div class="video-popup-content">
        <button id="closePopupBtn" class="close-popup">&times;</button>
        <iframe id="videoFrame" src="" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
</div>

<div th:replace="~{layout :: footer}"></div>

<script>
    function buyNow(price, productName) {
        const integerPrice = parseInt(price, 10);
        window.location.href = '/api/v1/transactions/create-payment?amount=' + integerPrice + '&orderInfo=' + encodeURIComponent('Thanh toan don hang ' + productName);
    }

    // Function to update price display when a package is selected
    function updatePrice(selectElement) {
        const selectedPrice = Number(selectElement.value || 0);
        // Find the price display span within the same parent container
        const priceDisplaySpan = selectElement.parentElement.querySelector('.price-display span');
        if (priceDisplaySpan) {
            // Format as Vietnamese currency (no decimals for VND)
            priceDisplaySpan.textContent = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).format(selectedPrice);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const videoPopup = document.getElementById('videoPopup');
        const videoFrame = document.getElementById('videoFrame');
        const closePopupBtn = document.getElementById('closePopupBtn');

            // Initialize: select the cheapest package and set price
            document.querySelectorAll('.package-selector').forEach(container => {
                const select = container.querySelector('.package-select-dropdown');
                const priceSpan = container.querySelector('.price-display span');
                if (!select || !priceSpan) return;

                const opts = Array.from(select.options);
                if (opts.length > 0) {
                    let minOption = opts[0];
                    let minVal = Number(minOption.value || Infinity);
                    for (const o of opts) {
                        const val = Number(o.value || Infinity);
                        if (val < minVal) { minVal = val; minOption = o; }
                    }
                    // Select the lowest-priced option
                    select.value = String(minOption.value);
                }

                const initPrice = Number(select.value || 0);
                priceSpan.textContent = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0
                }).format(initPrice);
            });

        // Helper: build an embeddable URL for popular platforms
        function buildEmbedUrl(rawUrl) {
            try {
                const u = new URL(rawUrl);
                const host = u.hostname.replace("www.", "");

                // YouTube variants
                if (host.includes('youtube.com') || host.includes('youtu.be')) {
                    let id = '';
                    if (host.includes('youtu.be')) {
                        id = u.pathname.split('/').filter(Boolean)[0] || '';
                    } else {
                        if (u.pathname === '/watch') {
                            id = u.searchParams.get('v') || '';
                        } else if (u.pathname.startsWith('/shorts/')) {
                            id = u.pathname.split('/')[2] || '';
                        } else if (u.pathname.startsWith('/embed/')) {
                            id = u.pathname.split('/')[2] || '';
                        } else if (u.pathname.startsWith('/live/')) {
                            id = u.pathname.split('/')[2] || '';
                        }
                    }
                    if (id) {
                        return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1`;
                    }
                }

                // Vimeo basic support
                if (host.includes('vimeo.com')) {
                    const parts = u.pathname.split('/').filter(Boolean);
                    const id = parts.pop();
                    if (id && /^\d+$/.test(id)) {
                        return `https://player.vimeo.com/video/${id}?autoplay=1`;
                    }
                }
            } catch (e) { /* ignore parse errors */ }
            return null; // not embeddable
        }

        // Video popup logic
        document.querySelectorAll('.view-demo-btn').forEach(button => {
            button.addEventListener('click', function () {
                const videoUrl = this.getAttribute('data-video-url');
                if (!videoUrl) return;

                const embedUrl = buildEmbedUrl(videoUrl);
                if (embedUrl) {
                    videoFrame.src = embedUrl;
                    videoPopup.style.display = 'flex';
                } else {
                    // Fallback: open in new tab if not embeddable
                    window.open(videoUrl, '_blank');
                }
            });
        });

        function closePopup() {
            videoPopup.style.display = 'none';
            videoFrame.src = ''; // Stop video playback
        }

        closePopupBtn.addEventListener('click', closePopup);
        videoPopup.addEventListener('click', function (e) {
            if (e.target === videoPopup) {
                closePopup();
            }
        });

        // Close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && videoPopup.style.display === 'flex') {
                closePopup();
            }
        });

        // Add click listener for all buy now buttons
        document.querySelectorAll('.buy-now-btn').forEach(button => {
            button.addEventListener('click', function() {
                const productCard = this.closest('.product-card-container');
                const selectElement = productCard.querySelector('.package-select-dropdown');
                const selectedPrice = selectElement.value;
                const productName = this.getAttribute('data-product-name');
                buyNow(selectedPrice, productName);
            });
        });
    });
</script>

</body>
</html>
